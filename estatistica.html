<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Controle Diário - Estatísticas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --body-bg-start: #4F81BD;
      --body-bg-end: #dc3545;
      --card-bg-color: rgba(255, 255, 255, 0.9);
      --card-border-color: rgba(0, 0, 0, 0.1);
      --text-color-light: #ffffff;
      --text-color-dark: #333333;
      --shadow-subtle: 0 6px 20px rgba(0, 0, 0, 0.25);
      --border-radius-card: 1rem;
    }

    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(160deg, var(--body-bg-start) 0%, var(--body-bg-end) 100%);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 1.5rem 2rem;
      color: var(--text-color-dark); /* Ajuste para ter texto visível nos cards brancos */
    }

    .container-custom {
      background-color: var(--card-bg-color);
      border-radius: var(--border-radius-card);
      box-shadow: var(--shadow-subtle);
      padding: 2rem;
      margin-top: 2rem;
      width: 100%;
      max-width: 1200px;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: var(--text-color-dark);
    }

    .form-control, .form-select {
      border-radius: 0.5rem;
      border: 1px solid var(--card-border-color);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
      background-color: var(--body-bg-start);
      border-color: var(--body-bg-start);
    }

    .btn-danger {
      background-color: var(--body-bg-end);
      border-color: var(--body-bg-end);
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 400px; /* Altura padrão para os gráficos */
    }
    .chart-container canvas {
      max-height: 100%;
      max-width: 100%;
    }

    .hidden {
      display: none !important;
    }

    .top-bar {
      width: 100%;
      max-width: 1200px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      margin-top: 1rem;
      color: var(--text-color-light); /* Texto branco para a barra superior */
    }
    .btn-back {
      background-color: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      text-decoration: none;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn-back:hover {
      background-color: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      color: white;
    }

    @media (max-width: 768px) {
      .container-custom {
        padding: 1.5rem;
        margin-top: 1rem;
      }
      h1 {
        font-size: 1.8rem;
      }
      .chart-container {
        height: 300px;
      }
      .top-bar {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="index.html" class="btn-back"><i class="fas fa-arrow-left me-2"></i>Voltar</a>
    <h1>Estatísticas Detalhadas</h1>
    <span></span>
  </div>

  <div class="container container-custom">
    <h2 class="mb-4 text-center">Dashboard Financeiro</h2>

    <div class="row mb-4">
      <div class="col-md-6 col-lg-4 mb-3">
        <label for="filtroPeriodo" class="form-label">Período:</label>
        <select class="form-select" id="filtroPeriodo">
          <option value="mensal">Mensal</option>
          <option value="anual">Anual</option>
        </select>
      </div>
      <div class="col-md-6 col-lg-8" id="selectoresMensal">
        <div class="row">
          <div class="col-sm-6 mb-3">
            <label for="filtroMes" class="form-label">Mês:</label>
            <select class="form-select" id="filtroMes">
              <option value="0">Janeiro</option>
              <option value="1">Fevereiro</option>
              <option value="2">Março</option>
              <option value="3">Abril</option>
              <option value="4">Maio</option>
              <option value="5">Junho</option>
              <option value="6">Julho</option>
              <option value="7">Agosto</option>
              <option value="8">Setembro</option>
              <option value="9">Outubro</option>
              <option value="10">Novembro</option>
              <option value="11">Dezembro</option>
            </select>
          </div>
          <div class="col-sm-6 mb-3">
            <label for="filtroAnoMensal" class="form-label">Ano:</label>
            <select class="form-select" id="filtroAnoMensal"></select>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-8 d-none" id="selectoresAnual">
        <div class="row">
          <div class="col-12 mb-3">
            <label for="filtroAnoAnual" class="form-label">Ano:</label>
            <select class="form-select" id="filtroAnoAnual"></select>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4">

    <div class="row">
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h4 class="card-title text-center mb-4">Receita vs. Lucro</h4>
            <div class="chart-container">
              <canvas id="graficoReceitaLucro"></canvas>
              <p id="noDataReceitaLucro" class="hidden text-center text-muted position-absolute top-50 start-50 translate-middle">Sem dados para o período selecionado.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h4 class="card-title text-center mb-4">Gastos por Categoria</h4>
            <div class="chart-container">
              <canvas id="graficoGastosPorCategoria"></canvas>
              <p id="noDataGastosCategoria" class="hidden text-center text-muted position-absolute top-50 start-50 translate-middle">Sem dados para o período selecionado.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h4 class="card-title text-center mb-4">Receita por Plataforma</h4>
            <div class="chart-container">
              <canvas id="graficoPlataforma"></canvas>
              <p id="noDataPlataforma" class="hidden text-center text-muted position-absolute top-50 start-50 translate-middle">Sem dados para o período selecionado.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h4 class="card-title text-center mb-4">Resumo Mensal de Receitas e Despesas</h4>
            <div class="row mb-3">
              <div class="col-6">
                <label for="filtroMesResumoMensal" class="form-label">Mês:</label>
                <select class="form-select" id="filtroMesResumoMensal">
                  <option value="0">Janeiro</option>
                  <option value="1">Fevereiro</option>
                  <option value="2">Março</option>
                  <option value="3">Abril</option>
                  <option value="4">Maio</option>
                  <option value="5">Junho</option>
                  <option value="6">Julho</option>
                  <option value="7">Agosto</option>
                  <option value="8">Setembro</option>
                  <option value="9">Outubro</option>
                  <option value="10">Novembro</option>
                  <option value="11">Dezembro</option>
                </select>
              </div>
              <div class="col-6">
                <label for="filtroAnoResumoMensal" class="form-label">Ano:</label>
                <select class="form-select" id="filtroAnoResumoMensal"></select>
              </div>
            </div>
            <div id="resumoMensalContent">
                <p>Receita Total: <strong id="resumoReceitaTotal">R$ 0.00</strong></p>
                <p>Despesa Total: <strong id="resumoDespesaTotal">R$ 0.00</strong></p>
                <p>Lucro/Prejuízo: <strong id="resumoLucroPrejuizo">R$ 0.00</strong></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-4">

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h4 class="card-title text-center mb-4">Resumo Diário Detalhado</h4>
            <div class="row mb-3">
                <div class="col-md-6 mb-3">
                    <label for="filtroMesTabela" class="form-label">Mês:</label>
                    <select class="form-select" id="filtroMesTabela">
                        <option value="0">Janeiro</option>
                        <option value="1">Fevereiro</option>
                        <option value="2">Março</option>
                        <option value="3">Abril</option>
                        <option value="4">Maio</option>
                        <option value="5">Junho</option>
                        <option value="6">Julho</option>
                        <option value="7">Agosto</option>
                        <option value="8">Setembro</option>
                        <option value="9">Outubro</option>
                        <option value="10">Novembro</option>
                        <option value="11">Dezembro</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="filtroAnoTabela" class="form-label">Ano:</label>
                    <select class="form-select" id="filtroAnoTabela"></select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Receitas</th>
                            <th>Despesas</th>
                            <th>Lucro Diário</th>
                        </tr>
                    </thead>
                    <tbody id="resumoDiarioTableBody">
                        </tbody>
                </table>
            </div>
            <p id="noDataTabelaDiaria" class="hidden text-center text-muted">Sem dados para o período selecionado.</p>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js';
    import { getFirestore, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    // Seus dados de configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCee4pXFdNxmdSv4VA90KdihyapXvAGt8w",
        authDomain: "controle-financeiro-e190f.firebaseapp.com",
        projectId: "controle-financeiro-e190f",
        storageBucket: "controle-financeiro-e190f.firebasestorage.app",
        messagingSenderId: "711653253846",
        appId: "1:711653253846:web:f633ce5cc025e2c8aedf77",
        measurementId: "G-ZKEY3BJN9G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserId = null;

    const filtroPeriodo = document.getElementById('filtroPeriodo');
    const filtroMes = document.getElementById('filtroMes');
    const filtroAnoMensal = document.getElementById('filtroAnoMensal');
    const filtroAnoAnual = document.getElementById('filtroAnoAnual');
    const filtroMesResumoMensal = document.getElementById('filtroMesResumoMensal');
    const filtroAnoResumoMensal = document.getElementById('filtroAnoResumoMensal');
    const filtroMesTabela = document.getElementById('filtroMesTabela');
    const filtroAnoTabela = document.getElementById('filtroAnoTabela');

    const selectoresMensal = document.getElementById('selectoresMensal');
    const selectoresAnual = document.getElementById('selectoresAnual');

    const ctxReceitaLucro = document.getElementById('graficoReceitaLucro').getContext('2d');
    const ctxGastosPorCategoria = document.getElementById('graficoGastosPorCategoria').getContext('2d');
    const ctxReceitaPorPlataforma = document.getElementById('graficoPlataforma').getContext('2d');

    let receitaLucroChart;
    let gastosPorCategoriaChart;
    let receitaPorPlataformaChart;

    function preencherAnos() {
        const currentYear = new Date().getFullYear();
        // Clear previous options to prevent duplicates
        filtroAnoMensal.innerHTML = '';
        filtroAnoAnual.innerHTML = '';
        filtroAnoResumoMensal.innerHTML = '';
        filtroAnoTabela.innerHTML = '';

        for (let i = currentYear; i >= 2020; i--) {
            const optionMensal = document.createElement('option');
            optionMensal.value = i;
            optionMensal.textContent = i;
            filtroAnoMensal.appendChild(optionMensal);

            const optionAnual = document.createElement('option');
            optionAnual.value = i;
            optionAnual.textContent = i;
            filtroAnoAnual.appendChild(optionAnual);

            const optionResumoMensal = document.createElement('option');
            optionResumoMensal.value = i;
            optionResumoMensal.textContent = i;
            filtroAnoResumoMensal.appendChild(optionResumoMensal);

            const optionTabela = document.createElement('option');
            optionTabela.value = i;
            optionTabela.textContent = i;
            filtroAnoTabela.appendChild(optionTabela);
        }
        // Set current year as selected
        filtroAnoMensal.value = currentYear;
        filtroAnoAnual.value = currentYear;
        filtroAnoResumoMensal.value = currentYear;
        filtroAnoTabela.value = currentYear;
    }

    function alternarSeletoresFiltro() {
        const periodo = filtroPeriodo.value;
        if (periodo === 'mensal') {
            selectoresMensal.classList.remove('d-none');
            selectoresAnual.classList.add('d-none');
        } else {
            selectoresMensal.classList.add('d-none');
            selectoresAnual.classList.remove('d-none');
        }
        atualizarGraficos();
    }

    async function atualizarGraficos() {
        if (!currentUserId) {
            console.log("Usuário não autenticado. Não é possível carregar gráficos.");
            return;
        }

        const periodo = filtroPeriodo.value;
        let registrosRef;
        let q;

        registrosRef = collection(db, `users/${currentUserId}/registros`);

        let selectedYear;
        let selectedMonth;

        if (periodo === 'mensal') {
            selectedMonth = parseInt(filtroMes.value);
            selectedYear = parseInt(filtroAnoMensal.value);
            const startOfMonth = new Date(selectedYear, selectedMonth, 1);
            const endOfMonth = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59, 999);

            q = query(
                registrosRef,
                where('data', '>=', startOfMonth.toISOString().split('T')[0]),
                where('data', '<=', endOfMonth.toISOString().split('T')[0]),
                orderBy('data', 'asc')
            );
        } else { // anual
            selectedYear = parseInt(filtroAnoAnual.value);
            const startOfYear = new Date(selectedYear, 0, 1);
            const endOfYear = new Date(selectedYear, 11, 31, 23, 59, 59, 999);

            q = query(
                registrosRef,
                where('data', '>=', startOfYear.toISOString().split('T')[0]),
                where('data', '<=', endOfYear.toISOString().split('T')[0]),
                orderBy('data', 'asc')
            );
        }

        try {
            const querySnapshot = await getDocs(q);
            const dados = querySnapshot.docs.map(doc => doc.data());

            // Processar dados para Receita vs Lucro
            renderizarGraficoReceitaLucro(dados, periodo);
            // Processar dados para Gastos por Categoria
            renderizarGraficoGastosPorCategoria(dados);
            // Processar dados para Receita por Plataforma
            renderizarGraficoReceitaPorPlataforma(dados);
            // Atualizar Resumo Mensal
            atualizarResumoMensal(dados, parseInt(filtroMesResumoMensal.value), parseInt(filtroAnoResumoMensal.value));
            // Atualizar Tabela de Resumo Diário
            renderizarTabelaResumoDiario(dados, parseInt(filtroMesTabela.value), parseInt(filtroAnoTabela.value));

        } catch (error) {
            console.error("Erro ao buscar dados do Firestore:", error);
            document.getElementById('noDataReceitaLucro').classList.remove('hidden');
            document.getElementById('graficoReceitaLucro').style.display = 'none';
            document.getElementById('noDataGastosCategoria').classList.remove('hidden');
            document.getElementById('graficoGastosPorCategoria').style.display = 'none';
            document.getElementById('noDataPlataforma').classList.remove('hidden');
            document.getElementById('graficoPlataforma').style.display = 'none';
            document.getElementById('noDataTabelaDiaria').classList.remove('hidden');
            document.getElementById('resumoDiarioTableBody').innerHTML = '';
            document.getElementById('resumoReceitaTotal').textContent = 'R$ 0.00';
            document.getElementById('resumoDespesaTotal').textContent = 'R$ 0.00';
            document.getElementById('resumoLucroPrejuizo').textContent = 'R$ 0.00';
        }
    }

    function renderizarGraficoReceitaLucro(data, periodo) {
        if (receitaLucroChart) {
            receitaLucroChart.destroy();
        }

        const dailyData = {}; // Agrega dados por dia
        data.forEach(record => {
            const date = record.data; // Data já está em YYYY-MM-DD
            if (!dailyData[date]) {
                dailyData[date] = { receita: 0, despesa: 0 };
            }
            if (record.receita) dailyData[date].receita += parseFloat(record.receita);
            if (record.gorjetas) dailyData[date].receita += parseFloat(record.gorjetas);
            if (record.despesas) dailyData[date].despesa += parseFloat(record.despesas);
        });

        const sortedDates = Object.keys(dailyData).sort();

        const labels = [];
        const receitas = [];
        const despesas = [];
        const lucros = [];

        sortedDates.forEach(date => {
            labels.push(date);
            const receitaDiaria = dailyData[date].receita;
            const despesaDiaria = dailyData[date].despesa;
            receitas.push(receitaDiaria);
            despesas.push(despesaDiaria);
            lucros.push(receitaDiaria - despesaDiaria);
        });

        if (labels.length > 0) {
            document.getElementById('graficoReceitaLucro').style.display = 'block';
            document.getElementById('noDataReceitaLucro').classList.add('hidden');

            receitaLucroChart = new Chart(ctxReceitaLucro, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Receita',
                            data: receitas,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Despesa',
                            data: despesas,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Lucro/Prejuízo',
                            data: lucros,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valor (R$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('graficoReceitaLucro').style.display = 'none';
            document.getElementById('noDataReceitaLucro').classList.remove('hidden');
        }
    }

    function renderizarGraficoGastosPorCategoria(data) {
        if (gastosPorCategoriaChart) {
            gastosPorCategoriaChart.destroy();
        }

        const categoryExpenses = {};
        data.filter(record => record.despesas > 0).forEach(record => {
            const category = record.categoriaDespesa || 'Outros';
            categoryExpenses[category] = (categoryExpenses[category] || 0) + parseFloat(record.despesas);
        });

        const labels = Object.keys(categoryExpenses);
        const values = Object.values(categoryExpenses);

        if (labels.length > 0) {
            document.getElementById('graficoGastosPorCategoria').style.display = 'block';
            document.getElementById('noDataGastosCategoria').classList.add('hidden');

            const backgroundColors = [
                '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6610f2', '#007bff', '#28a745'
            ];

            gastosPorCategoriaChart = new Chart(ctxGastosPorCategoria, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed);
                                        const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(2);
                                        label += ` (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('graficoGastosPorCategoria').style.display = 'none';
            document.getElementById('noDataGastosCategoria').classList.remove('hidden');
        }
    }

    function renderizarGraficoReceitaPorPlataforma(data) {
      if (receitaPorPlataformaChart) {
          receitaPorPlataformaChart.destroy();
      }

      const plataformasTotal = {
          'Uber': 0,
          '99': 0,
          'Outras': 0
      };

      data.filter(record => record.receita > 0).forEach(record => {
          const plataforma = record.plataforma;
          const receita = parseFloat(record.receita) + parseFloat(record.gorjetas || 0);
          if (plataforma === 'Uber') {
              plataformasTotal['Uber'] += receita;
          } else if (plataforma === '99') {
              plataformasTotal['99'] += receita;
          } else {
              plataformasTotal['Outras'] += receita;
          }
      });

      const hasData = Object.values(plataformasTotal).some(value => value > 0);

      if (hasData) {
          document.getElementById('graficoPlataforma').style.display = 'block';
          document.getElementById('noDataPlataforma').classList.add('hidden');

          receitaPorPlataformaChart = new Chart(ctxReceitaPorPlataforma, {
              type: 'bar',
              data: {
                  labels: ['Uber', '99', 'Outras'],
                  datasets: [{
                      label: 'Receita por Plataforma (R$)',
                      data: [plataformasTotal['Uber'], plataformasTotal['99'], plataformasTotal['Outras']],
                      backgroundColor: ['#000000', '#ffc107', '#6c757d']
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { display: false },
                      tooltip: {
                          callbacks: {
                              label: function(context) {
                                  let label = context.dataset.label || '';
                                  if (label) {
                                      label += ': ';
                                  }
                                  if (context.parsed.y !== null) {
                                      label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                  }
                                  return label;
                              }
                          }
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          title: {
                              display: true,
                              text: 'Valor (R$)'
                          },
                          ticks: {
                              callback: function(value) {
                                  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                              }
                          }
                      }
                  }
              }
          });
      } else {
          document.getElementById('graficoPlataforma').style.display = 'none';
          document.getElementById('noDataPlataforma').classList.remove('hidden');
      }
    }

    function atualizarResumoMensal(allData, selectedMonth, selectedYear) {
        const resumoReceitaTotal = document.getElementById('resumoReceitaTotal');
        const resumoDespesaTotal = document.getElementById('resumoDespesaTotal');
        const resumoLucroPrejuizo = document.getElementById('resumoLucroPrejuizo');

        let totalReceita = 0;
        let totalDespesa = 0;

        allData.forEach(record => {
            const recordDate = new Date(record.data + 'T00:00:00'); // Garante que a data seja interpretada como local
            if (recordDate.getMonth() === selectedMonth && recordDate.getFullYear() === selectedYear) {
                if (record.receita) totalReceita += parseFloat(record.receita);
                if (record.gorjetas) totalReceita += parseFloat(record.gorjetas);
                if (record.despesas) totalDespesa += parseFloat(record.despesas);
            }
        });

        const lucroPrejuizo = totalReceita - totalDespesa;

        resumoReceitaTotal.textContent = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalReceita);
        resumoDespesaTotal.textContent = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(totalDespesa);
        resumoLucroPrejuizo.textContent = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(lucroPrejuizo);

        resumoLucroPrejuizo.style.color = lucroPrejuizo >= 0 ? 'green' : 'red';
    }

    function renderizarTabelaResumoDiario(allData, selectedMonth, selectedYear) {
        const resumoDiarioTableBody = document.getElementById('resumoDiarioTableBody');
        const noDataTabelaDiaria = document.getElementById('noDataTabelaDiaria');
        resumoDiarioTableBody.innerHTML = '';
        noDataTabelaDiaria.classList.add('hidden');

        const dailySummary = {};

        allData.forEach(record => {
            const recordDate = new Date(record.data + 'T00:00:00');
            if (recordDate.getMonth() === selectedMonth && recordDate.getFullYear() === selectedYear) {
                const dateKey = record.data; // YYYY-MM-DD
                if (!dailySummary[dateKey]) {
                    dailySummary[dateKey] = { receitas: 0, despesas: 0 };
                }
                if (record.receita) dailySummary[dateKey].receitas += parseFloat(record.receita);
                if (record.gorjetas) dailySummary[dateKey].receitas += parseFloat(record.gorjetas);
                if (record.despesas) dailySummary[dateKey].despesas += parseFloat(record.despesas);
            }
        });

        const sortedDates = Object.keys(dailySummary).sort();

        if (sortedDates.length === 0) {
            noDataTabelaDiaria.classList.remove('hidden');
            return;
        }

        sortedDates.forEach(dateKey => {
            const summary = dailySummary[dateKey];
            const lucroDiario = summary.receitas - summary.despesas;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(dateKey + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                <td>${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(summary.receitas)}</td>
                <td>${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(summary.despesas)}</td>
                <td style="color: ${lucroDiario >= 0 ? 'green' : 'red'};">${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(lucroDiario)}</td>
            `;
            resumoDiarioTableBody.appendChild(row);
        });
    }


    // Event Listeners e inicialização
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserId = user.uid;
            console.log('Usuário logado em estatistica.html:', currentUserId);
            preencherAnos();
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            filtroMes.value = currentMonth;
            filtroMesResumoMensal.value = currentMonth;
            filtroMesTabela.value = currentMonth;
            
            filtroAnoMensal.value = currentYear;
            filtroAnoAnual.value = currentYear;
            filtroAnoResumoMensal.value = currentYear;
            filtroAnoTabela.value = currentYear;

            alternarSeletoresFiltro(); // Carrega os gráficos após o usuário estar logado
        } else {
            console.log('Nenhum usuário logado em estatistica.html. Redirecionando...');
            window.location.href = 'login.html';
        }
    });

    filtroPeriodo.addEventListener('change', alternarSeletoresFiltro);
    filtroMes.addEventListener('change', atualizarGraficos);
    filtroAnoMensal.addEventListener('change', atualizarGraficos);
    filtroAnoAnual.addEventListener('change', atualizarGraficos);
    
    filtroMesResumoMensal.addEventListener('change', () => atualizarGraficos());
    filtroAnoResumoMensal.addEventListener('change', () => atualizarGraficos());

    filtroMesTabela.addEventListener('change', () => atualizarGraficos());
    filtroAnoTabela.addEventListener('change', () => atualizarGraficos());
  </script>
</body>
</html>